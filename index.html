<!DOCTYPE html>
<html>

<meta charset="utf-8">

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r" crossorigin="anonymous">

<style type="text/css">
  body { padding-top: 70px; }
</style>

<title></title>

<!-- navbar -->
<nav class="navbar navbar-inverse navbar-fixed-top">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">collagen</a>
    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav" id="navbar_buttons"></ul>
    </div>
  </div>
</nav>

<div class="container" id="main">
  <!-- template list -->
  <div class="container" id="template_list"></div>
  <!-- template view -->
  <div class="row" id="template_view"></div>
</div>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
<!-- KiiSDK v2.4.1 -->
<script src="js/kii.js"></script>

<script type="text/javascript">
$(function() {
  var appID = '681081e4';
  var appKey = 'c370e906d88a8164ba14cb456ad7bf48';
  Kii.initializeWithSite(appID, appKey, KiiSite.JP);

  showTemplateList();
});

function hideAll() {
  $('#main').children().hide();
  $('#navbar_buttons').html('');
}

function showTemplateList() {
  hideAll();

  // prepare navbar
  var a_add = $('<a href="#"><span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span> テンプレを作成</a>');
  //a_add.click(showTemplateList);

  $('<li />').append(a_add).appendTo('#navbar_buttons');

  // show template list
  $('#template_list').show();

  // if template is already exists, do nothing
  if ($('#template_list').children().length > 0) {
    return;
  }

  var bucket = Kii.bucketWithName('template');
  var query = KiiQuery.queryWithClause(null);
  query.sortByDesc('_created');
  query.setLimit(15);

  bucket.executeQuery(query).then(
    function(params) {
      var results = params[1];
      var nextQuery = params[2];

      var row;

      results.forEach(function(obj) {
        if (!row || row.children().length == 4) {
          row = $('<div class="row" />');
          $('#template_list').append(row);
        }

        var col = $('<div class="col-md-3" />');

        var a = $('<a href="#" class="thumbnail"'
          + 'template_id="' + obj.getUUID() + '" '
          + 'template_title="' + obj.get('title') + '" />');
        a.click(function() {
          showTemplateView($(this).attr('template_id'), $(this).attr('template_title'));
        });

        row.append(col.append(a));

        obj.downloadBody().then(
          function(params) {
            var body = params[1];

            var img = $('<img />');
            img.attr({ 'src': window.URL.createObjectURL(body) });
            img.attr({ 'style': 'max-width:' + a.width() + 'px;max-height:' + a.width() + 'px;' });

            a.append(img);
          },
          function(errObj) {
          });
      });
    },
    function(errObj) {
    });
};

function showTemplateView(template_id, template_title) {
  hideAll();

  // prepare navbar
  var a_list = $('<a href="#"><span class="glyphicon glyphicon-circle-arrow-left" aria-hidden="true"></span> テンプレ一覧に戻る</a>');
  a_list.click(showTemplateList);

  var a_add = $('<a href="#"><span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span> このテンプレで作成</a>');
  //a_add.click(showTemplateList);

  $('<li />').append(a_list).appendTo('#navbar_buttons');
  $('<li />').append(a_add).appendTo('#navbar_buttons');

  // clear and show template view
  $('#template_view').html('');
  $('#template_view').show();

  var bucket = Kii.bucketWithName(template_id);
  var query = KiiQuery.queryWithClause(null);
  query.sortByDesc('_created');
  query.setLimit(15);

  bucket.executeQuery(query).then(
    function(params) {
      var results = params[1];
      var nextQuery = params[2];

      results.forEach(function(result) {
        var div = $('<div class="col-md-4" />');

        var a = $('<a href="#" class="thumbnail" id="' + result.getUUID() + '" />');
        a.click(function() {
        });

        var img = $('<img src="data:image/svg+xml;base64,' + result.get('thumbnail') + '" />');

        div.append(a.append(img)).appendTo('#template_view');
      });
    },
    function(errObj) {
    });
}

</script>

</html>
